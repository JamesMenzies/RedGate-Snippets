{
  "id": "6863aff5-c831-4fc2-bcc9-11445e06faec",
  "prefix": "qi",
  "description": "Broker Queue Investigations",
  "body": "SELECT\r\nSCHEMA_NAME ( q.schema_id ) SchemaName\r\n, q.name QueueName\r\n, p.rows QueueRows\r\n, q.is_enqueue_enabled\r\n, q.is_activation_enabled\r\n--, CASE WHEN q.activation_procedure IS NOT NULL THEN FORMATMESSAGE ('EXEC %s',q.activation_procedure) ELSE '' END activation_procedure\r\n--, FORMATMESSAGE ( 'ALTER QUEUE %s.%s WITH STATUS = %s %s', SCHEMA_NAME ( q.schema_id ), q.name, CASE q.is_enqueue_enabled WHEN 1 THEN 'OFF' WHEN 0 THEN 'ON' END, CASE WHEN q.is_activation_enabled = 1 THEN ', ACTIVATION (STATUS = OFF)' WHEN q.is_activation_enabled = 0 AND q.activation_procedure IS NOT NULL THEN ', ACTIVATION (STATUS = ON)' ELSE '' END) alter_queue\r\n--, FORMATMESSAGE( 'SELECT status, priority, queuing_order, CAST(message_body AS NVARCHAR(MAX)) message_body, ice.decompress_xml(message_body) message_xml, conversation_group_id, conversation_handle, message_sequence_number, service_name, service_contract_name, message_type_name, message_type_id, message_enqueue_time FROM %s.%s', SCHEMA_NAME ( q.schema_id ), q.name ) query_queue\r\nFROM sys.service_queues q\r\nJOIN sys.objects o ON o.object_id = q.object_id\r\nJOIN sys.objects i ON i.parent_object_id = q.object_id\r\nJOIN sys.partitions p ON p.object_id = i.object_id\r\nAND p.index_id IN ( 0, 1 )\r\nORDER BY p.rows DESC, q.is_activation_enabled, q.name"
}